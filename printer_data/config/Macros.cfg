####################################################################
#	Macros
#####################################################################
[gcode_macro PID_EXTRUDER]
gcode:
  M106
  PID_CALIBRATE HEATER=extruder TARGET=260
  M107

[gcode_macro PID_BED]
gcode:
  PID_CALIBRATE HEATER=heater_bed TARGET=110

[gcode_macro BELT_TENSIONING]
gcode:
  G28
  G1 Y115 F6000 
  G1 X126 F6000


#[gcode_macro G32]
#gcode:
    #BED_MESH_CLEAR
    #G28
    #QUAD_GANTRY_LEVEL
    #G28
    ##	Uncomment for for your size printer:
    #--------------------------------------------------------------------
    ##	Uncomment for 250mm build
    #G0 X125 Y125 Z30 F3600
    
    ##	Uncomment for 300 build
    #G0 X150 Y150 Z30 F3600
    
    ##	Uncomment for 350mm build
    #G0 X175 Y175 Z30 F3600
    #--------------------------------------------------------------------
[gcode_macro AUTO_Z_OFFSET]
gcode: 
  CALIBRATE_Z
[gcode_macro Z_END_CALI]
gcode: 
  Z_ENDSTOP_CALIBRATE


[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    G32                            ; home all axes
    G1 Z20 F3000                   ; move nozzle away from bed 

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-1.0 F3600                 ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z2 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0 X192 Y200 F12000          ; park nozzle at rear
    BED_MESH_CLEAR

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
gcode:
  TURN_OFF_HEATERS
  CANCEL_PRINT
  Smart_Park  

[gcode_macro 1STOP_SHIT_PRINT]
gcode:
    PAUSE
    SAVE_CONFIG

#[gcode_macro CANCEL_PRINT]
#rename_existing: BASE_CANCEL_PRINT
#gcode:
    #PAUSE
    #SAVE_CONFIG
  
  





#[gcode_macro BED_MESH]
gcode:
  G28
  M401
  Z_TILT_ADJUST
  G28
  BED_MESH_CALIBRATE
  M402




[gcode_macro UNLOAD_FILAMENT]
gcode:
    M83
    G1 E10 F200
    M83
    G1 E-37 F2000
    G4 P2000 wait 2 sec
    G1 E-150 F2000

##################################

[gcode_macro LOAD_FILAMENT]
gcode:
    M83
    G1 E140 F900
   
######################################

[gcode_macro START]
gcode:
    SET_PIN PIN=caselight VALUE=0.75
    $ M83
    G1 Z5.0 F3000 ; Move Z Axis up little to prevent scratching of Heat Bed
    #G1 X8 Y150 Z0.3 F10000.0 ; Move to start position
    #G1 X8 Y20.0 Z0.3 F3500 E20 ; Draw the first line
    #G92 E0 ; Reset Extruder
    #G1 Z3.0 F5000 ; Move Z Axis up little to prevent scratching of Heat Bed
    BED_MESH_PROFILE LOAD="default"
    SET_SKEW XY=99.86,99.76,70.56
   

[gcode_macro END]
gcode:
    SET_SKEW CLEAR=1

    G91 ;Relative positioning

    G1 E-2 Z0.2 F2400 ;Retract and raise Z

    G1 X5 Y5 F3000 ;Wipe out

    G1 Z2 ;Raise Z more

    G90 ;Absolute positionning

    G1 X190 Y230 F15000 ;Present print

    M106 S0 ;Turn-off fan

    M104 S0 ;Turn-off hotend

    M140 S0 ;Turn-off bed

    G92 E0 ; Reset Extruder
    
    M84 X Y E Z ;Disable all steppers but Z
    SET_PIN PIN=caselight VALUE=0.8

#############################

   
[gcode_macro SHAPER_CALI]
gcode:
    G28
    SHAPER_CALIBRATE

################################

[gcode_macro M600]
gcode:
    {% set X = params.X|default(50)|float %}
    {% set Y = params.Y|default(0)|float %}
    {% set Z = params.Z|default(10)|float %}
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE
    G91
    G1 E-.8 F2700
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F3000
    G91
    G1 E-50 F1000
    RESTORE_GCODE_STATE NAME=M600_state


[gcode_macro PID_HEATER]
gcode:
  M106 S255
  PID_CALIBRATE HEATER=extruder TARGET=275

[gcode_macro SAVECONFIG]
gcode:
  save_config

[gcode_macro Y_LUBE]
gcode:
    G1 X115 F16000 
    G1 Y50 F16000
    G1 Y200 F16000
    G1 Y50 F16000
    G1 Y200 F16000
    G1 Y50 F16000
    G1 Y200 F16000
    G1 Y50 F16000
    G1 Y200 F16000
    G1 Y115 F6000 
    G1 X120 F6000

[gcode_macro X_LUBE]
gcode:
    G1 Y120 F16000 
    G1 X50 F16000
    G1 X200 F16000
    G1 X50 F16000
    G1 X200 F16000
    G1 X50 F16000
    G1 X200 F16000
    G1 X50 F16000
    G1 X200 F16000
    G1 X50 F16000
    G1 X200 F16000
    G1 Y115 F6000 
    G1 X120 F6000

[gcode_macro Z_LUBE]
gcode:
  G1 Z30.000 F800
  G1 Z150.000 F800
  G1 Z30.000 F800
  G1 Z150.000 F800
  G1 Z30.000 F800
  G1 Z150.000 F800
  G1 Z30.000 F800

[gcode_macro M486]
gcode:
  # Parameters known to M486 are as follows:
  #   [C<flag>] Cancel the current object
  #   [P<index>] Cancel the object with the given index
  #   [S<index>] Set the index of the current object.
  #       If the object with the given index has been canceled, this will cause
  #       the firmware to skip to the next object. The value -1 is used to
  #       indicate something that isn’t an object and shouldn’t be skipped.
  #   [T<count>] Reset the state and set the number of objects
  #   [U<index>] Un-cancel the object with the given index. This command will be
  #       ignored if the object has already been skipped

  {% if 'exclude_object' not in printer %}
    {action_raise_error("[exclude_object] is not enabled")}
  {% endif %}

  {% if 'T' in params %}
    EXCLUDE_OBJECT RESET=1

    {% for i in range(params.T | int) %}
      EXCLUDE_OBJECT_DEFINE NAME={i}
    {% endfor %}
  {% endif %}

  {% if 'C' in params %}
    EXCLUDE_OBJECT CURRENT=1
  {% endif %}

  {% if 'P' in params %}
    EXCLUDE_OBJECT NAME={params.P}
  {% endif %}

  {% if 'S' in params %}
    {% if params.S == '-1' %}
      {% if printer.exclude_object.current_object %}
        EXCLUDE_OBJECT_END NAME={printer.exclude_object.current_object}
      {% endif %}
    {% else %}
      EXCLUDE_OBJECT_START NAME={params.S}
    {% endif %}
  {% endif %}

  {% if 'U' in params %}
    EXCLUDE_OBJECT RESET=1 NAME={params.U}
  {% endif %}
